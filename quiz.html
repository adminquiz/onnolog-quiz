<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OnnoLog Quiz</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --p: #4A90E2; --s: #2ECC71; --dark: #2C3E50; --light: #F4F7F6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { background: white; width: 92%; max-width: 450px; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        .hidden { display: none; }
        .btn { background: var(--p); color: white; border: none; padding: 15px; border-radius: 12px; cursor: pointer; width: 100%; font-weight: bold; font-size: 18px; margin: 10px 0; }
        .option-btn { background: white; color: var(--dark); border: 2px solid #eee; text-align: left; font-size: 16px; }
        #timer-bar { width: 100%; height: 8px; background: #eee; border-radius: 4px; margin: 15px 0; overflow: hidden; }
        #timer-fill { width: 100%; height: 100%; background: var(--s); transition: width 1s linear; }
        input { width: 100%; padding: 15px; border-radius: 10px; border: 2px solid #ddd; box-sizing: border-box; font-size: 16px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container" id="screen-home">
    <h1 style="color: var(--dark)">üìä <span style="color: var(--p)">OnnoLog</span> Quiz</h1>
    <input type="text" id="username" placeholder="Seu Nome">
    <button class="btn" onclick="startQuiz()">ENTRAR NO DESAFIO</button>
</div>

<div class="container hidden" id="screen-quiz">
    <div style="display:flex; justify-content:space-between; font-weight:bold;">
        <span id="score-txt">0 pts</span>
        <span id="timer-txt">30s</span>
    </div>
    <div id="timer-bar"><div id="timer-fill"></div></div>
    <h3 id="q-text" style="min-height: 50px;">Carregando...</h3>
    <div id="options-box"></div>
</div>

<div class="container hidden" id="screen-ranking">
    <h2>üèÜ Melhores Pontua√ß√µes</h2>
    <div id="loading-ranking">Salvando resultado...</div>
    <table id="ranking-table" class="hidden" style="width:100%; border-collapse: collapse;">
        <thead><tr><th>Pos</th><th>Nome</th><th>Pontos</th></tr></thead>
        <tbody></tbody>
    </table>
    <button class="btn" onclick="location.reload()" style="margin-top:20px; background: var(--dark);">JOGAR NOVAMENTE</button>
</div>

<script>
    const _supabase = supabase.createClient('https://zdthxlhknxpbdfzcozls.supabase.co', 'sb_publishable_6gT5fcstwt1QLjCf5PCAPA_2Ec_6mU4');
    let questions = [], currentQ = 0, score = 0, acertosReais = 0, timeLeft = 30, timerInterval, user = "";

    async function startQuiz() {
        user = document.getElementById('username').value.trim();
        if(!user) return alert("Por favor, digite Seu Nome!");
        const { data, error } = await _supabase.from('perguntas').select('*');
        if(error || !data || data.length === 0) return alert("Erro ao carregar perguntas ou banco vazio.");
        questions = data;
        document.getElementById('screen-home').classList.add('hidden');
        document.getElementById('screen-quiz').classList.remove('hidden');
        showQuestion();
    }

    function showQuestion() {
        if(currentQ >= questions.length) return endQuiz();
        timeLeft = 30; updateTimer();
        const data = questions[currentQ];
        document.getElementById('q-text').innerText = data.pergunta;
        const box = document.getElementById('options-box'); box.innerHTML = "";
        let opts = data.opcoes.map((o, i) => ({o, i})).sort(() => Math.random() - 0.5);
        opts.forEach(item => {
            const b = document.createElement('button');
            b.className = "btn option-btn"; b.innerText = item.o;
            b.onclick = () => handleAnswer(item.i === data.correta);
            box.appendChild(b);
        });
        clearInterval(timerInterval);
        timerInterval = setInterval(() => { timeLeft--; updateTimer(); if(timeLeft <= 0) handleAnswer(false); }, 1000);
    }

    function updateTimer() {
        document.getElementById('timer-txt').innerText = timeLeft + "s";
        document.getElementById('timer-fill').style.width = (timeLeft/30*100) + "%";
        document.getElementById('timer-fill').style.background = timeLeft < 10 ? "#e74c3c" : "#2ecc71";
    }

    function handleAnswer(isCorrect) {
        clearInterval(timerInterval);
        if(isCorrect) {
            score += 500 + (timeLeft * 20);
            acertosReais++; // Contador de acerto real
        }
        document.getElementById('score-txt').innerText = score + " pts";
        currentQ++;
        setTimeout(showQuestion, 400);
    }

    async function endQuiz() {
        document.getElementById('screen-quiz').classList.add('hidden');
        document.getElementById('screen-ranking').classList.remove('hidden');
        
        // Salva com a nova coluna acertos_reais
        const { error } = await _supabase.from('ranking').insert([{ 
            nome: user, 
            pontos: score, 
            acertos_reais: acertosReais 
        }]);

        if(error) console.error("Erro ao salvar ranking:", error);
        showRanking();
    }

    async function showRanking() {
        const { data } = await _supabase.from('ranking').select('*').order('pontos', { ascending: false }).limit(10);
        document.getElementById('loading-ranking').classList.add('hidden');
        const table = document.getElementById('ranking-table');
        table.classList.remove('hidden');
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = data.map((s, i) => `<tr style="border-bottom: 1px solid #eee;"><td style="padding:10px;"><b>${i+1}¬∫</b></td><td>${s.nome}</td><td>${s.pontos}</td></tr>`).join('');
    }
</script>
</body>
</html>